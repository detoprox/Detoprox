<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Detoprox — UI mínima</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    h1 { margin: 0 0 12px; }
    .row { display: flex; gap: 12px; align-items: center; margin-bottom: 16px; }
    input, button { padding: 8px 10px; font-size: 14px; }
    table { border-collapse: collapse; width: 100%; margin-top: 16px; }
    th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; font-size: 14px; }
    th { background: #f8fafc; }
    .muted { color: #6b7280; font-size: 12px; margin-top: 4px; }
    .error { color: #b91c1c; margin-top: 8px; }
  </style>
</head>
<body>
  <h1>Inventario Detoprox</h1>
  <div class="row">
    <input id="nombre" placeholder="Nombre del producto" />
    <input id="precio" type="number" step="0.01" placeholder="Precio" />
    <input id="stock" type="number" placeholder="Stock" />
    <label><input id="activo" type="checkbox" /> Activo</label>
    <button id="add">Agregar</button>
  </div>
  <div class="row">
    <input id="search" placeholder="Buscar por nombre..." />
    <button id="refresh">Actualizar</button>
    <span class="muted">Usa la API en <code>/api/productos/</code></span>
  </div>

  <table>
    <thead>
      <tr><th>ID</th><th>Nombre</th><th>Precio</th><th>Stock</th><th>Activo</th><th>Acciones</th></tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div id="msg" class="error" style="display:none;"></div>

  <script>
    const API = '/api/productos/';
    const $ = (id) => document.getElementById(id);
    const msg = $('msg');

    function showError(e) {
      msg.style.display = 'block';
      msg.textContent = typeof e === 'string' ? e : (e?.message || 'Error');
      setTimeout(() => (msg.style.display = 'none'), 4000);
    }

    async function list() {
      try {
        const q = $('search').value.trim();
        const url = q ? `${API}?search=${encodeURIComponent(q)}` : API;
        const res = await fetch(url);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        const tb = $('tbody');
        tb.innerHTML = '';
        (Array.isArray(data) ? data : []).forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row.id ?? ''}</td>
            <td>${row.nombre ?? ''}</td>
            <td>${row.precio ?? ''}</td>
            <td>${row.stock ?? ''}</td>
            <td>${row.activo ? '✔' : ''}</td>
            <td>
              <button data-id="${row.id}" class="del">Eliminar</button>
            </td>
          `;
          tb.appendChild(tr);
        });
        tb.querySelectorAll('.del').forEach(btn => {
          btn.addEventListener('click', async () => {
            try {
              const id = btn.getAttribute('data-id');
              const res = await fetch(API + encodeURIComponent(id), { method: 'DELETE' });
              if (!res.ok) throw new Error('HTTP ' + res.status);
              await list();
            } catch (e) { showError(e); }
          });
        });
      } catch (e) { showError(e); }
    }

    async function add() {
      try {
        const body = {
          nombre: $('nombre').value.trim(),
          precio: Number($('precio').value || 0),
          stock: Number($('stock').value || 0),
          activo: !!$('activo').checked
        };
        const res = await fetch(API, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(body)
        });
        if (!res.ok) throw new Error(await res.text());
        $('nombre').value = ''; $('precio').value = ''; $('stock').value = ''; $('activo').checked = false;
        await list();
      } catch (e) { showError(e); }
    }

    $('add').addEventListener('click', add);
    $('refresh').addEventListener('click', list);
    $('search').addEventListener('keydown', (ev) => { if (ev.key === 'Enter') list(); });

    list();
  </script>
</body>
</html>
